---
title: Initial analyses on the effect of PRT vs CBT and UC on auditory pain response
author: "Andrew Leroux"
date: "`r Sys.Date()`"
output:
  # pdf_document:
    # toc: yes
  # toc_depth: 4
  # number_sections: yes
  html_document:
    code_folding: show
    number_sections: yes
    toc: yes
    toc_float: yes
    toc_collapsed: yes
theme: lumen
---
<!-- <script type="text/x-mathjax-config"> -->
<!-- MathJax.Hub.Config({ -->
<!--   TeX: { equationNumbers: { autoNumber: "AMS" } } -->
<!-- }); -->
<!-- </script> -->


# Scope 

The goal of this vignette is to provide reproducible workflow summarizing the key methods and results from an initial analysis of the effect of PRT on reducing perceived pain from auditory stimulus.

The vignette is divided into sections which are listed and described briefly below.

- *Executive summary*: Provides a high level overview of the implications of the analyses described in detail in the remainder of the document 
- *Preliminaries*: Loads packages associated with data manipulation, regression analyses, and plotting
- *Exploratory Data Analysis*: Plots and summary statistics which were used to inform the statistical methods used in subsequent analyses
- *Statistical Analyses*: Defines the statistical models and presents results from analysis of these data

# Executive summary

This report is an investigation of the following primary scientific question of interest: is there is an effect of PRT on participants' average reported pain as compared to either the placebo or usual care arms? From our primary analysis, we find that there are statistically significant differences in pain comparing PRT to placebo for both high and low exposures, with a larger effect of PRT in low exposure responses. Additionally, the effect of PRT on reducing reported pain scores is significantly lower in for high exposures. However, though the direction of the associations similar when comparing PRT to the usual care arm, they are not statistically significant. For additional details, see Section 5.1.
        
        



# Preliminiaries

The code below loads packages necessary for data manipulation and analyses. The packages and their uses here are listed below:

* *here*: setting paths relative to R project 
* *tidyverse*: data tidying/manipulation
* *ggplot2*: general plotting
* *gt*: making tables for the report
* *nlme*: software for fitting generalized linear mixed models. Here **nlme** is used as it allows for specifying random effects models *and* additional correlation on residuals, unlike the **lme4** package
* *mgcv*: general purpose software for fitting generalized additive mixed models, used for fitting statistical models that cannot be easily done in the nlme package, specifically methodology involving penalized regression splines
* *qgam* additive quantile mixed models
* *multcomp* contrasts and multiple comparisons adjustment


```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r packages, message=FALSE, warning=FALSE}
rm(list=ls())
pckgs <- c("here","tidyverse","ggplot2","nlme","mgcv","qgam","multcomp")
invisible(
        sapply(pckgs, function(x) if(!require(x,character.only=TRUE,quietly=TRUE)) {
                install.packages(x)
                require(x, character.only=TRUE,quietly=TRUE)
        })
)
rm(list=c("pckgs"))
theme_set(theme_classic())
```

# Exploratory Data Analysis

## Read in the data

First we load the data and do some data manipulation, specifically creating factor variables for trial arm, time (baseline, pre vs post intervention), and intensity of exposure. Note: here we make the assumption that temporal exposure order is presented for participants row-wise (i.e., the first row for a participant is their first exposure).

```{r load_data, message=FALSE, warning=FALSE}
## load the data
path = here("data")
df <- read_csv(here(path,"behaviour_table_all.csv"))
## create factor variables for trial arm, time (pre vs post), and intensity
df <- 
    df %>% 
    mutate(group_fac = factor(Group, levels=c(1,2,3), labels=c("PRT","placebo","usual care")),
           time_fac = factor(Time, levels=c(0,1), labels=c("pre","post")),
           intensity_fac = factor(Intensity,levels=c(1,2), labels=c("low","high"))) %>% 
    group_by(Subject, time_fac) %>% 
    mutate(record = (1:n()) + Time*10,
           record_2 = 1:n()) %>% 
    ungroup()

df <- 
    df %>% 
    mutate(Subject_fac = factor(Subject),
           Subject_time = (paste0(Subject,"_",time_fac)),
           Subject_time_fac = factor(paste0(Subject,"_",time_fac)))

```

## Study design

First, look at the distribution of ordering of intensity (low vs high) across groups. Overall at a group level, the trends seem random, consistent with the study design (randomized order)

```{r tables_pt1, message=F, warning=F, fig.height=5, fid.width=7}
# round(prop.table(table(df$intensity_fac, df$record_2, df$group_fac), margin=c(2,3)),2)
plt_order <- 
    df %>% 
    group_by(group_fac, time_fac, record_2) %>% 
    summarize(prop_low_intensity = mean(intensity_fac == "low"),
              prop_high_intensity = 1-prop_low_intensity) %>% 
    pivot_longer(cols=c("prop_low_intensity", "prop_high_intensity"), 
                 names_to = "Intensity", values_to = "proportion") %>% 
    mutate(Intensity = factor(Intensity, levels=c("prop_low_intensity","prop_high_intensity"),
                              labels=c("Low intensity","High intensity"))) %>% 
    ggplot() + 
    geom_line(aes(x=record_2, y=proportion, color=group_fac)) + facet_grid(Intensity~time_fac) + 
    ggtitle("Proportion of High vs Low Exposure by Temporal Ordering") + 
    xlab("Temporal Ordering") + scale_x_continuous(breaks=1:10) + 
    geom_hline(yintercept=0.5, col='grey',lty=2)
plt_order
```

Looking at a heatmap of ordering at the indiviudal level, we seethat the ordering does appear to be random, with the apparent constraint that no more than 2 consecutive exposures can be of the same intensity

```{r tables_pt2, message=F, warning=F, fig.height=5, fid.width=15}
plt_order_individual <- 
    df %>% 
    group_by(group_fac) %>% 
    mutate(subject_fac = as.numeric(factor(Subject))) %>% 
    ggplot() + 
    geom_raster(aes(x=record_2, y=subject_fac, fill=intensity_fac)) + 
    facet_grid(group_fac~time_fac) + ylab("Participant") + xlab("Temporal Ordering") + 
    ggtitle("Individual ordering of high vs low intensity exposures") + scale_x_continuous(breaks=1:10) 
plt_order_individual
```

Next, look at how many records each participant has (this can be seen in the heatmap above, but participant identifiers are re-ordered for plotting purposes). We see that there are a few participants with missing data (IDs 69, 108, 604, 605, 699, 1103, 1141), but most participants have complete data. Moreover, there does not appear to be systematic differences in missing data for low vs high exposures. Only one particpant (ID 1103) stands out, with only 4 data points in the post-intervention assessment. 

```{r tables_pt3}
table(df$intensity_fac, df$Subject, df$time_fac)
```

## Plotting the outcome (pain score) data

### Population Distributions

First, using boxplots, plot the distribution of pain intensity reported at pre and post periods (x-axis), stratified by low (left panel) vs high exposure (right panel) for each trial arm (color). We see that at baseline (pre) participants in the placebo and usual care arms tended to report lower pain than the PRT arm. Additionally, the difference appears to vary slightly by high vs low exposures. As a result, for our regression models, we will adjust for baseline group differences.


```{r eda_pt1, message=FALSE, warning=FALSE}
df %>% 
    ggplot() + 
    geom_boxplot(aes(x=time_fac, y=Rating, fill=group_fac), notch=T) + 
    facet_grid(~intensity_fac)
```


If we look at the distribution of outcomes by temporal ordering of exposure, there doesn't appear to be a strong trend, though there is some evidence that average reported pain increases for later high intensity exposures (note the median of the blue boxplots tends to increase slightly across pre and post periods for each trial arm). This suggests adjusting for exposure sequence in our statistical model may be appropriate.


```{r eda_dist_temp_pop}
plt_dist_pop <-
    df %>%
    mutate(record_2_fac = cut(record_2, c(0, 2, 4, 6, 8, 10))) %>%
    ggplot() + 
    geom_boxplot(aes(x=factor(record_2_fac), y=Rating, fill=intensity_fac)) + 
    facet_grid(group_fac~time_fac) + 
    xlab("Temporal Ordering") + ylab("Reported Pain") + 
    ggtitle("Distribution of reported pain by temporal ordering")
plt_dist_pop
```



Given the bounded nature of the data, we are also concerned with potential the potential for a strong mean-variance relationship which would violate the heterskedasticity assumption of linear regression. To assess this, several figures were considered. First, the mean and standard deviation of report pain was stratified by the $q^{th}$ percentiles of the data ($q \in 10, 20, 40, 60, 80, 90, 100$) and temporal ordering (intensity was also considered but no meaningful trends emerged and so the results are not included here). 

The plot below shows that, consistent with the previous figure, there does not appear to be a strong temporal trend in either average or standard deviation of the outcome. However, the variability of reported pain tends to be highest for very low or very high values of reported pain. 

This effect can be partially explained by skewness within the quantiles of reported pain (see frequency plot below), though the potential effect is worth considering in regression analyses.


```{r eda_dist_temp, message=FALSE, warning=FALSE,fig.align="center", fig.width=20, fig.height=5}
plt_dist_summ <- 
    df %>%
    mutate(record_2_fac = cut(record_2, c(0, 2, 4, 6, 8, 10)),
           record_2_fac_num = as.numeric(record_2_fac)) %>%
    mutate(rating_quintile = cut(Rating, c(-1, quantile(Rating, c(0.1,0.2, 0.4, 0.6, 0.8,0.9)), 100))) %>%
    # group_by(rating_quintile, group_fac, time_fac, intensity_fac, record_2_fac_num) %>%
    group_by(rating_quintile, group_fac, time_fac, record_2_fac_num) %>%
    summarize(mn_Y = mean(Rating),
              sd_Y = sd(Rating)) %>%
    ungroup() %>%
    pivot_longer(cols=c("mn_Y","sd_Y"), names_to="measure") %>%
    ggplot(aes(x=record_2_fac_num, y=value, color=group_fac)) +
    geom_point() + geom_line() + scale_x_continuous(breaks=c(1:5),labels=c("(0,2]","(2,4]","(4,6]","(6,8]","(8,10]")) + 
    facet_grid(measure~time_fac + rating_quintile, scales="free_y") + 
    ggtitle("Distribution of mean and standard deviation stratified by rating quantile") + 
    xlab("Temporal Ordering")
plt_dist_summ

```

```{r eda_dist_temp_hist}
df %>%
    ggplot() + 
    geom_freqpoly(aes(x=Rating, color=intensity_fac, alpha=0.5)) + 
    facet_grid(group_fac~time_fac) + ggtitle("Frequencies of Reported Pain by Study Arm") + 
    xlab("Ratin")
    
```

### Individual level EDA

#### Trajectories




```{r heatmap_individuals}
df %>% 
    group_by(Subject, time_fac) %>% 
    mutate(mn_rating_pre = mean(Rating[time_fac == "pre"])) %>% 
    ungroup() %>% 
    group_by(group_fac) %>% 
    arrange(mn_rating_pre, time_fac, record_2) %>% 
    mutate(subj_group_plot = 4)
```

#### Participant level variation

Calculating participant specific averages and standard deviation of reported pain, we see further evidence that variability (generally) exhibits an inverted U shaped association with participant averages. However, there does appear to be some bimodality in the mean-variance relationship in the PRT group in the post-intervention period for *high* exposures. 

An additional point to note is that we see substantial variability in participants' reported pain. Our model should therefore consider modelling these sources of heterogeneous variability in some fashion. 



```{r eda_individuals_pt2, message=F, warning=F}
df %>% 
    group_by(Subject, intensity_fac, time_fac) %>% 
    summarize(mn_Y = mean(Rating),
              sd_Y = sd(Rating),
              group_fac=group_fac[1]) %>%
    ungroup() %>%
    mutate(time_intensity_fac = paste0(time_fac, ", ", intensity_fac)) %>% 
    ggplot() + 
    geom_point(aes(x=mn_Y, y=sd_Y, color=time_intensity_fac)) + 
    facet_grid(~group_fac, scales="free_y") + 
    geom_smooth(aes(x=mn_Y, y=sd_Y, color=time_intensity_fac), method="gam", formula=y~s(x,bs="cr",k=10)) + 
    ylab("Participant-specific standard deviation of reported pain") + 
    xlab("Participant-specific average reported pain")
```


Next we examine the correlation of participants' average and variability of reported pain between the pre and post periods. The figure below shows that pre and post average reported pain are positively correlated, though some notable exceptions are clearly present. For example there are 3 participants (one in each trial arm) who report effectively 0 pain at baseline for high and low exposures, but relatively high levels of pain at the post-intervention assessment. Additionally, one participant in the placebo group reported high pain at baseline, but effectively 0 post-intervention. The data for these participants are plotted for reference.

Lastly, note that the correlation between average pre and post ratings appears relatively consistent across the groups and is approximately linear (barring the influence of potential outlying points).

```{r eda_individuals_pt3, message=F, warning=F}
df %>% 
    group_by(Subject, intensity_fac, time_fac) %>% 
    summarize(mn_Y = mean(Rating),
              sd_Y = sd(Rating),
              group_fac=group_fac[1]) %>%
    ungroup() %>%
    pivot_longer(cols=c("mn_Y","sd_Y"), names_to="measure") %>%
    pivot_wider(names_from="time_fac", values_from = "value") %>%
    # mutate(time_intensity_fac = paste0(time_fac, ", ", intensity_fac)) %>% 
    ggplot() + 
    geom_point(aes(x=pre, y=post, color=intensity_fac)) + 
    facet_wrap(measure~group_fac, scales="free_x",ncol=3) + 
    geom_smooth(aes(x=pre, y=post, color=intensity_fac), method="gam", formula=y~s(x,bs="cr",k=10)) + 
    ylab("Post-Intervention") + 
    xlab("Pre-Intervention") + ggtitle("Pre vs Post Changes in Mean and Variability")
```

There are a few clear outliers in the data. Of particular note are participants who report very high (low) scores at baseline versus low (high) scores at the post intervention period. Four participants were identified by visual inspection, and their data are plotted below. After discussing with Dr. Ashar, it was decided that for the primary analysis two of these participants would be excluded as their data appear to be  invalid/implausible. Specifically, we exclude participants 1029 and 1231 in the usual care arm and placebo arms, respectively. Note that based on their data, excluding these two participants has the effect of favoring PRT versus placebo while favoring usual care over PRT. 


```{r eda_individuals_pt4, message=F, warning=F}
df %>% 
    filter(Subject %in% c(904, 1029, 1103, 1231)) %>% 
    mutate(Subject_group = paste0("ID ", Subject, ", ", group_fac)) %>% 
    ggplot() + 
    geom_point(aes(x=record_2, y=Rating, color=intensity_fac)) + 
    facet_grid(Subject_group~time_fac) + 
    geom_line(aes(x=record_2, y=Rating, color=intensity_fac)) +
    ylab("Temporal Ordering") + 
    xlab("Rating") + ggtitle("Trajectories for outlying participants")
```


Next we explore the potential for heterogeneity exists in individuals' average and slope. To do so we fit linear regression models to each participants' baseline and post intervention data separately. We extracted the estimated intercepts and slopes from these models, then calculated the difference in intercept and slope for each participant separately. The boxplots below show the distribution of these differences for the intercepts (left panel, delta_intercept) and slopes (right panel, delta_slope). From these boxplots it's clear that there are substantial differences in both intercept and slopes for a number of participants, and that the differences are heterogeneous (wide spread). While the heterogeneity could potentially be explained by randomization of the high vs low exposures, these findings suggest that a model which allows for subject-specific random intercepts and slopes at both baseline and post-intervention periods may be appropriate.



```{r eda_individual_variability_intercept_slope}
plt_intercepts <- 
    df %>% 
    group_by(Subject, Time) %>% 
    summarize(mn_Y = mean(Rating, na.rm=T)) %>% 
    ungroup()

plt_slopes <- 
    df %>% 
    group_by(Subject, Time) %>% 
    summarize(mn_Y = mean(Rating, na.rm=T)) %>% 
    ungroup()


df_int_slopes <- 
    df %>% 
  group_by(Subject,Time) %>% 
  do(data.frame(., as.list(coef(lm(Rating ~ record_2, data = .))))) %>%
  rename_at(14:15, ~c("intercept", "slope")) %>% 
  slice(1) %>% ungroup() %>%
  dplyr::select(Subject, time_fac, group_fac, intercept, slope) %>% 
    dplyr::select(Subject, time_fac,intercept, slope) %>% 
    pivot_wider(names_from=time_fac, values_from=c(intercept, slope)) %>% 
    mutate(delta_intercept = intercept_post - intercept_pre,
           delta_slope = slope_post - slope_pre)

df %>% 
    dplyr::select(Subject, group_fac) %>% 
    group_by(Subject) %>% slice(1) %>% ungroup() %>%
    left_join(df_int_slopes, ., by="Subject") %>% 
    dplyr::select(Subject, group_fac, delta_intercept,delta_slope) %>%
    pivot_longer(cols=c("delta_intercept","delta_slope")) %>%
    ggplot() + 
    geom_boxplot(aes(x=group_fac, color=group_fac, y=value), alpha=0.5) + 
    theme_classic() + 
    facet_wrap(~name, ncol=2, scales="free_y") + 
    xlab("Difference in pre-post intercepts and slopes")
```

 








# Statistical Analyses

Before introducing our proposed statistical model, we first introduce some notation. Let $Y_{ijk}$ denote participant $i$'s reported pain intensity for study period $j$ ($j=1$, pre; $j=2$, post) on the $k^{\text{th}}$ exposure. To account for the clear sources of heterskedasticity in the data, as well as the various sources of correlation within participants' data, we propose to model the data using a Gaussian Location Scale mixed model. For our data, these models take the general form
\begin{align*}
Y_{ijk}|\text{fixed}_{ijk} + \text{random}_{ij}  &= \text{fixed}_{ijk} + \text{random}_{ij} + \text{error}_{ijk} \\
\text{error}_{ijk} & \sim N(0, \sigma_{ijk}) \\
\text{log}(\sigma_{ijk}) &= \text{fixed}_{ijk}^\sigma + \text{random}_{ij}^\sigma 
\end{align*}
where $\text{fixed}_{ijk}$ represent the fixed effects, $\text{random}_{ij}$ are normally distributed random effects which capture between person-visit variability, and $\text{error}_{ijk}$ are the residual noise which capture within person-visit variability. Note that the fixed and random components modelling the location (mean) and scale (variance) may contain overlapping components, though they need not be identical (hence the $\sigma$ superscript on the formula for $\text{log}(\sigma_{ijk})$).

For our analysis, we propose the following specific model
\begin{align*}
Y_{ijk}|\text{fixed}_{ijk} 
                &=\mu_0 +\beta_1 \text{placebo}_i + \beta_2 \text{UC}_i + \beta_3\text{High}_{ijk} \\
                &\hspace{0.5cm}\nu_1 \text{placebo}_i \times \text{High}_{ijk} + \nu_2 \text{UC}_i \times \text{High}_{ijk}   + \\
                &\hspace{0.5cm}\gamma_1  \times 1(J=2) + \gamma_2 \text{High}_{ijk} \times 1(J=2) \\
                                &\hspace{0.5cm}\alpha_1 \times 1(J=2) \times \text{placebo}_i + \alpha_2\text{High}_{ijk} \times 1(J=2) \times \text{placebo}_i \\ \\
               &\hspace{0.5cm}  \delta_1 \text{UC}_i \times 1(J=2) +  \delta_2 \text{High}_{ijk} \times 1(J=2) \times \text{UC}_i +  \\
               & \hspace{0.5cm} f(k) + \\
                 &\hspace{0.5cm} b_{i0} + b_{ij} + b_{i0} \times k + b_{ij} \times k +  \text{error}_{ijk} \\ \\
\text{log}(\sigma_{ijk}) &= \mu_{0,\sigma} + \beta_{1,\sigma}1(J=2) + b_{i0,\sigma} + b_{ij,\sigma}
\end{align*}

**The location/mean model:** 

This model is a time (J) by intervention by intensity model, allowing for baseline group differences. For interpretation,         $\mu_0$ is the average pain in PRT group for low intensity exposures at baseline. The $\beta_c$ parameters represent differences in pain at baseline comparing groups ($\beta_1, \beta_2)$ and high vs low exposures in PRT arm ($\beta_3$). The $\nu_c$ parameters are the group differences in high vs low pain comparing PRT  and placebo ($\nu_1$) and usual care arms ($\nu_2$) at baseline. 
        
$\gamma_1$ is the intervention effect of PRT on the low auditory response. $\gamma_2$ is the *difference* between the effect of PRT on high vs low auditory exposure. $\alpha_1$ and $\delta_1$ are the effects of PRT on low auditory expsoure comparing placebo and usual care, respectively. $\alpha_2$ and $\delta_2$ have a similar interpretation as $\gamma_2$, specifically they are the difference in the effect of high vs low exposure comparing PRT to the placebo and usual care arms, respectively. 

Finally,  $f(k)$ is a potentially non-linear effect of expsosure order modelled using penalized regression splines. 

The random effects allow for participant specific random intercepts ($b_{i0}$ and $b_{ij}$) as well as random slopes on the expsoure order ($ b_{ij} + b_{i0} \times k$ and $b_{ij} \times k$) for the baseline and post-intervention periods.



**The variance/scale model:** 

The variance/scale model allows for residual error to differ between baseline and post-intervention periods ($\beta_1,\sigma$) and subject/period specific effects ($b_{i0,\sigma}$ and $b_{ij,\sigma}$).


**Hypothesis testing:** 

The effect of PRT on low auditory exposure can be assessed directly by performing inference on $\alpha_1$ and $\delta_1$. However, to assess the effect of PRT on high auditory expsoures, we need to evaluate a constrast. Specifically, $(\gamma_1 + \gamma_2) - (\alpha_1 + \alpha_2)$ (placebo vs PRT) and  $(\gamma_1 + \gamma_2) - (\delta_1 + \delta_2)$


## The primary analysis

Below we first filter out the identified outliuers, then fit the proposed model. 



```{r fit_model_joint, eval=T, cache=T}
df_analysis <- 
    df %>% 
    filter(!Subject %in%  c(1231, 1029)) %>% 
    mutate()
fit_gaulss <- gam(list(Rating ~ group_fac*time_fac*intensity_fac + s(record_2) + s(Subject_fac, bs="re") + 
                            s(Subject_time_fac, bs="re") + s(Subject_time_fac, by=record_2, bs="re"),
                        ~ time_fac + s(Subject_fac, bs="re")+ s(Subject_time_fac, bs="re")), 
                  data=df_analysis, family=gaulss())
# summary(fit_gaulss)
```


The code chunk below provides a function that facilitates convenient comparisons of the relevant hypothesis tests using the multcomp package.

```{r do_contrasts}
make_contr_mat <- function(fit){
    contr_mat <- matrix(0, nrow=6, ncol=length(coef(fit)))
    rownames(contr_mat) <- c("PRT: low",
                             "PRT: high vs low",
                             "PRT vs placebo: low",
                             "PRT vs placebo: high vs low",
                             "PRT vs UC: low",
                             "PRT vs UC: high vs low")
    colnames(contr_mat) <- names(coef(fit))
    # PRT: low
    contr_mat[1,"time_facpost"] <- 1
    # PRT: high
    contr_mat[2,"time_facpost:intensity_fachigh"] <- 1
    # PRT vs placebo: low
    contr_mat[3,"group_facplacebo:time_facpost"] <- 1
    # PRT vs placebo: high
    contr_mat[4,"group_facplacebo:time_facpost:intensity_fachigh"] <- -1
    contr_mat[4,"time_facpost:intensity_fachigh"] <- 1
    # PRT vs UC: low
    contr_mat[5,"group_facusual care:time_facpost"] <- 1
    # PRT vs UC: high
    contr_mat[6,"group_facusual care:time_facpost:intensity_fachigh"] <- -1
    contr_mat[4,"time_facpost:intensity_fachigh"] <- 1
    contr_mat
}

``` 


Below we print out the results. We find significantly smaller effects of PRT on high intensity exposures, as well as significant effects of PRT versus placebo. The effect of PRT is over two times larger on low intensity exposures than high. There are no significant effects of PRT when compared to usual care, though the direction of the estimates are consistent with the findings in the placebo group. Note that these tests do not correct for multiple comparisons.

```{r print_contrasts_unadjusted}
contr_mat_gaulss <- make_contr_mat(fit_gaulss)
## print results, no multiple comparisons
contrasts_gaulss <- glht(fit_gaulss, linfct = contr_mat_gaulss)
summary(contrasts_gaulss,test=adjusted(type="none"))
```


A note: correcting for multiple comparisons (shown below), we do not find statistically significant results.

```{r print_contrasts_adjusted}
## print results, multiple comparisons
summary(contrasts_gaulss)
```



## Sensitivity Analyses

Several sensitivity analyses were performed. In particular, we estimated a simplified model with only subject-specific random effects in the residual variability (simplified model) and a model fit to the entire dataset, including outliers. These models are fit below, followed by summary output for the relevant statistical hypothesis tests from each of these models. 

Additionally, we fit a comparable quantile regression model which does not make any distributional assumptions on the data. 


```{r fit_model_joint_sensitivity, eval=T, cache=T}
fit_gaulss_simplified <- gam(list(Rating ~ group_fac*time_fac*intensity_fac + s(record_2) + s(Subject_fac, bs="re") + 
                            s(Subject_time_fac, bs="re") + s(Subject_time_fac, by=record_2, bs="re"),
                        ~ time_fac + s(Subject_fac, bs="re")), 
                        data=df_analysis, family=gaulss())
# summary(fit_gaulss_simplified)


fit_gaulss_all_subjs <- gam(list(Rating ~ group_fac*time_fac*intensity_fac + s(record_2) + s(Subject_fac, bs="re") + 
                            s(Subject_time_fac, bs="re") + s(Subject_time_fac, by=record_2, bs="re"),
                        ~ time_fac + 
                            s(Subject_fac, bs="re")+ s(Subject_time_fac, bs="re") + 
                            1), data=df, family=gaulss())
# summary(fit_gaulss_all_subjs)
```


Below, we print the output from the simplified model. The results are consistent with the primary analysis. 


```{r print_constrasts_sensitivity_simplified}
## simplified model
contr_mat_simplified <- make_contr_mat(fit_gaulss_simplified)
contrasts_simplified <- glht(fit_gaulss_simplified, linfct = contr_mat_simplified)
summary(contrasts_simplified,test=adjusted(type="none"))
```

Below, we print the output from the model when fit to the whole dataset. The scientific conclusions here change slightly due to the presence of the outlier favoring the placebo group. Here, though the effect is estimated to be larger in for low expsoures, it is not statistically significant. Otherwise, the results are consistent with the primary analysis.

```{r print_constrasts_sensitivity_all_subjs}
## all participants
contr_mat_all_subjs <- make_contr_mat(fit_gaulss_all_subjs)
contrasts_all_subjs <- glht(fit_gaulss_all_subjs, linfct = contr_mat_all_subjs)
summary(contrasts_all_subjs,test=adjusted(type="none"))
```


Below, we fit the quantile regression model. Specifically, we're estimating the median response.

```{r fit_model_joint_sensitivity_qreg, eval=T, cache=T}
fit_qgam_all_subjs <- qgam(Rating ~ group_fac*time_fac*intensity_fac + s(record_2) + s(Subject_fac, bs="re") + 
                             s(Subject_time_fac, bs="re") + s(Subject_time_fac, by=record_2, bs="re"),
                             data=df, qu=0.5)
# summary(fit_qgam_all_subjs)
```


The results from our quantile regression are presented below. While we do not find statisticalyl significant results, the direction of the estimated associations are consistent with our regression models. The lack of statistical significance is not surprising given the generally reduced power of quantile regression.

```{r print_constrasts_sensitivity_qgam}
## all participants
contr_mat_qgam <- make_contr_mat(fit_qgam_all_subjs)
contrasts_qgam <- glht(fit_qgam_all_subjs, linfct = contr_mat_qgam)
data.frame(summary(contrasts_qgam,test=adjusted(type="none"))$test[-c(1,2,7)])
```



```{r qgam_contratsts, echo=F, eval=F}
contr_mat <- matrix(0, nrow=6, ncol=length(coef(fit_qgam_all_subjs)))
rownames(contr_mat) <- c("PRT: low",
                         "PRT: high vs low",
                         "PRT vs placebo: low",
                         "PRT vs placebo: high vs low",
                         "PRT vs UC: low",
                         "PRT vs UC: high vs low")
colnames(contr_mat) <- names(coef(fit_qgam_all_subjs))
# PRT: low
contr_mat[1,"time_facpost"] <- 1
# PRT: high
contr_mat[2,"time_facpost:intensity_fachigh"] <- 1
# PRT vs placebo: low
contr_mat[3,"group_facplacebo:time_facpost"] <- 1
# PRT vs placebo: high
contr_mat[4,"group_facplacebo:time_facpost:intensity_fachigh"] <- -1
contr_mat[4,"time_facpost:intensity_fachigh"] <- 1
# PRT vs UC: low
contr_mat[5,"group_facusual care:time_facpost"] <- 1
# PRT vs UC: high
contr_mat[6,"group_facusual care:time_facpost:intensity_fachigh"] <- -1
contr_mat[4,"time_facpost:intensity_fachigh"] <- 1
contrasts_qgam <- glht(fit_qgam_all_subjs, linfct = contr_mat)
summary(contrasts_qgam,test=adjusted(type="none"))
```



<!-- ## The conditional model -->


<!-- \begin{align*} -->
<!-- a -->
<!-- \end{align*} -->

<!-- ```{r fit_model_conditional,eval=F} -->
<!-- df_gam <-  -->
<!--     df %>%  -->
<!--     filter(time_fac == "post") %>%  -->

<!-- df_gam_pre <-   -->
<!--     df %>%  -->
<!--     filter(time_fac == "pre") -->
<!-- uid <- unique(df$Subject) -->
<!-- nid <- length(uid) -->
<!-- nj <- nrow(df_gam) -->
<!-- Xmat <- matrix(50, nj, 10) -->
<!-- Imat_high <- matrix(0, nj, 10) -->
<!-- Lmat <- matrix(0, nj, 10) -->
<!-- for(i in 1:nid){ -->
<!--     id_i <- uid[i] -->
<!--     inx_post_i <- which(df_gam$Subject == id_i) -->
<!--     inx_pre_i <- which(df_gam_pre$Subject == id_i) -->

<!--     Lmat[inx_post_i,1:length(inx_pre_i)] <- 1/length(inx_pre_i) -->

<!--     Xmat_i <- matrix(df_gam_pre$Rating[inx_pre_i], length(inx_post_i), length(inx_pre_i), byrow=T) -->
<!--     Xmat[inx_post_i,1:length(inx_pre_i)] <- Xmat_i -->

<!--     Imat_i <- matrix(as.numeric(df_gam_pre$intensity_fac[inx_pre_i] == "high"),length(inx_post_i), length(inx_pre_i), byrow=T) -->
<!--     Imat_high[inx_post_i,1:length(inx_pre_i)] <- Imat_i -->
<!-- } -->

<!-- df_gam[["Xmat"]] <- Xmat -->
<!-- df_gam[["Lmat"]] <- Lmat -->
<!-- df_gam[["Imat_high"]] <- Imat_high -->
<!-- df_gam[["LImat_high"]] <- Imat_high*Lmat -->
<!-- df_gam[["UC_mat"]] <- matrix(as.numeric(df_gam$group_fac == "usual care"), nj, 10) -->
<!-- df_gam[["placebo_mat"]] <- matrix(as.numeric(df_gam$group_fac == "placebo"), nj, 10) -->

<!-- fit_gam <- gam(Rating ~ s(Xmat, by=Lmat, bs="cr", k=10), data=df_gam, method="REML") -->
<!-- fit_gam <- gam(Rating ~ s(Xmat, by=Lmat, bs="cr", k=10) +  -->
<!--                    s(Xmat, by=LImat_high, bs="cr", k=10) +  -->
<!--                    group_fac*intensity_fac +  -->
<!--                    s(Subject_fac, bs="re") +  -->
<!--                    record_2 + -->
<!--                    s(Subject_fac, by=record_2, bs="re"), data=df_gam, method="REML") -->
<!-- summary(fit_gam) -->



<!-- fit_gam_gaulss_full <-  -->
<!--     gam(list(Rating ~  -->
<!--                  s(Xmat, by=Lmat, bs="cr", k=10) +  -->
<!--                  s(Xmat, by=LImat_high, bs="cr", k=10) + -->
<!--                  group_fac*intensity_fac +  -->
<!--                  s(Subject_fac, bs="re") +  -->
<!--                  s(Subject_time_fac, bs="re") +  -->
<!--                  s(record_2) + -->
<!--                  s(Subject_time_fac, by=record_2, bs="re"), -->
<!--              ~ s(Xmat, by=Lmat, bs="cr", k=10) +  -->
<!--                  s(Xmat, by=LImat_high, bs="cr", k=10) + -->
<!--                  group_fac*intensity_fac +  -->
<!--                  s(Subject_fac, bs="re") + -->
<!--                  s(Subject_time_fac, bs="re") + -->
<!--                  record_2 + -->
<!--                  s(Rating, bs="cr",k=10) +  -->
<!--                  s(Subject_time_fac, by=record_2, bs="re") + -->
<!--                  1),  -->
<!--         data=df_gam, method="REML", -->
<!--         family=gaulss) -->

<!-- fit_gam_gaulss <-  -->
<!--     gam(list(Rating ~  -->
<!--                  s(Xmat, by=Lmat, bs="cr", k=10) +  -->
<!--                  s(Xmat, by=LImat_high, bs="cr", k=10) + -->
<!--                  group_fac*intensity_fac +  -->
<!--                  s(Subject_fac, bs="re") +  -->
<!--                  s(record_2) + -->
<!--                  s(Subject_fac, by=record_2, bs="re"), -->
<!--              ~ s(Xmat, by=Lmat, bs="cr", k=10) +  -->
<!--                  s(Xmat, by=LImat_high, bs="cr", k=10) + -->
<!--                  group_fac*intensity_fac +  -->
<!--                  s(Subject_fac, bs="re") + -->
<!--                  record_2 + -->
<!--                  s(Rating, bs="cr",k=10) +  -->
<!--                  s(Subject_fac, by=record_2, bs="re") + -->
<!--                  1),  -->
<!--         data=df_gam, method="REML", -->
<!--         family=gaulss) -->

<!-- # df_gam$resids <- resid(fit_gam_gaulss) -->
<!-- #  -->
<!-- # resid_mat <-  -->
<!-- #     df_gam %>%  -->
<!-- #     dplyr::select(record_2, Subject_fac, resids) %>%  -->
<!-- #     pivot_wider(names_from="record_2", values_from=resids) -->
<!-- # cor_mat <-  -->
<!-- #     resid_mat %>%  -->
<!-- #     dplyr::select(-Subject_fac) %>%  -->
<!-- #     as.matrix() %>%  -->
<!-- #     cor(., use="pairwise.complete.obs") -->
<!-- # fields::image.plot(cor_mat) -->





<!-- fit_gam_gaulss_sub <-  -->
<!--     gam(list(Rating ~  -->
<!--                  s(Xmat, by=Lmat, bs="cr", k=10) +  -->
<!--                  s(Xmat, by=LImat_high, bs="cr", k=10) + -->
<!--                  group_fac + intensity_fac +  -->
<!--                  s(Subject_fac, bs="re") +  -->
<!--                  s(record_2) + -->
<!--                  s(Subject_fac, by=record_2, bs="re"), -->
<!--              ~ s(Xmat, by=Lmat, bs="cr", k=10) +  -->
<!--                  s(Xmat, by=LImat_high, bs="cr", k=10) + -->
<!--                  group_fac+intensity_fac +  -->
<!--                  s(Subject_fac, bs="re") + -->
<!--                  s(record_2) + -->
<!--                  s(Rating, bs="cr",k=10) +  -->
<!--                  s(Subject_fac, by=record_2, bs="re") + -->
<!--                  1),  -->
<!--         data=df_gam, method="REML", -->
<!--         family=gaulss) -->
<!-- summary(fit_gam_gaulss_sub) -->



<!-- fit_gam_gaulss_sub2 <-  -->
<!--     gam(list(Rating ~  -->
<!--                  s(Xmat, by=Lmat, bs="cr", k=10) +  -->
<!--                  s(Xmat, by=LImat_high, bs="cr", k=10) + -->
<!--                  group_fac + intensity_fac +  -->
<!--                  s(Subject_fac, bs="re") +  -->
<!--                  s(record_2) + -->
<!--                  s(Subject_fac, by=record_2, bs="re"), -->
<!--              ~ s(Xmat, by=Lmat, bs="cr", k=10) +  -->
<!--                  s(Xmat, by=LImat_high, bs="cr", k=10) + -->
<!--                  group_fac+intensity_fac +  -->
<!--                  s(Subject_fac, bs="re") + -->
<!--                  s(record_2) + -->
<!--                  1),  -->
<!--         data=df_gam, method="REML", -->
<!--         family=gaulss) -->
<!-- summary(fit_gam_gaulss_sub2) -->
<!-- ``` -->


<!-- ```{r plot_REs,eval=F} -->
<!-- re_gam_joint <- coef(fit_gam_gaulss) -->
<!-- re_slope_t2 <- re_gam_joint[430:549] -->

<!-- uidt <- unique(df$Subject_time_fac) -->
<!-- nidt <- length(uidt) -->
<!-- slopes <- rep(NA, nidt) -->
<!-- for(i in 1:nidt){ -->
<!--     df_i <-  -->
<!--         df %>%  -->
<!--         filter(Subject_time_fac == uidt[i]) -->
<!--     if(nrow(df_i) < 4){ -->
<!--         next -->
<!--     } -->
<!--     slopes[i] <- coef(lm(Rating ~ )) -->
<!-- } -->
<!-- ``` -->

<!-- ## -->


