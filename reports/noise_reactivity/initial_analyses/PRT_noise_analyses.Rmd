---
title: Initial analyses on the effect of PRT vs CBT and UC on auditory pain response
author: "Andrew Leroux"
date: "`r Sys.Date()`"
output:
  # pdf_document:
    # toc: yes
  # toc_depth: 4
  # number_sections: yes
  html_document:
    code_folding: show
    number_sections: yes
    toc: yes
    toc_float: yes
    toc_collapsed: yes
theme: lumen
---
<!-- <script type="text/x-mathjax-config"> -->
<!-- MathJax.Hub.Config({ -->
<!--   TeX: { equationNumbers: { autoNumber: "AMS" } } -->
<!-- }); -->
<!-- </script> -->


# Scope 

The goal of this vignette is to provide reproducible workflow summarizing the key methods and results from an initial analysis of the effect of PRT on reducing perceived pain from auditory stimulus.

The vignette is divided into sections which are listed and described briefly below.

- *Executive summary*: Provides a high level overview of the implications of the analyses described in detail in the remainder of the document 
- *Preliminaries*: Loads packages associated with data manipulation, regression analyses, and plotting
- *Exploratory Data Analysis*: Plots and summary statistics which were used to inform the statistical methods used in subsequent analyses
- *Statistical Analyses*: Defines the statistical models and presents results from analysis of these data

# Executive summary

# Preliminiaries

The code below loads packages necessary for data manipulation and analyses. The packages and their uses here are listed below:

* *here*: setting paths relative to R project 
* *tidyverse*: data tidying/manipulation
* *ggplot2*: general plotting
* *gt*: making tables for the report
* *nlme*: software for fitting generalized linear mixed models. Here **nlme** is used as it allows for specifying random effects models *and* additional correlation on residuals, unlike the **lme4** package
* *mgcv*: general purpose software for fitting generalized additive mixed models, used for fitting statistical models that cannot be easily done in the nlme package, specifically methodology involving penalized regression splines


```{r packages, message=FALSE, warning=FALSE}
rm(list=ls())
pckgs <- c("here","tidyverse","ggplot2","nlme","mgcv")
invisible(
        sapply(pckgs, function(x) if(!require(x,character.only=TRUE,quietly=TRUE)) {
                install.packages(x)
                require(x, character.only=TRUE,quietly=TRUE)
        })
)
rm(list=c("pckgs"))
theme_set(theme_classic())
```

# Exploratory Data Analysis

## Read in the data

First we load the data and do some data manipulation, specifically creating factor variables for trial arm, time (baseline, pre vs post intervention), and intensity of exposure. Note: here we make the assumption that temporal exposure order is presented for participants row-wise (i.e., the first row for a participant is their first exposure).

```{r load_data, message=FALSE, warning=FALSE}
## load the data
path = here("data")
df <- read_csv(here(path,"behaviour_table.csv"))
## create factor variables for trial arm, time (pre vs post), and intensity
df <- 
    df %>% 
    mutate(group_fac = factor(Group, levels=c(1,2,3), labels=c("PRT","placebo","usual care")),
           time_fac = factor(Time, levels=c(0,1), labels=c("pre","post")),
           intensity_fac = factor(Intensity,levels=c(1,2), labels=c("low","high"))) %>% 
    group_by(Subject, time_fac) %>% 
    mutate(record = (1:n()) + Time*10,
           record_2 = 1:n()) %>% 
    ungroup()

df <- 
    df %>% 
    mutate(Subject_fac = factor(Subject),
           Subject_time = (paste0(Subject,"_",time_fac)),
           Subject_time_fac = factor(paste0(Subject,"_",time_fac)))

```

## Study design

First, look at the distribution of ordering of intensity (low vs high) across groups. Overall at a group level, the trends seem random, consistent with the study design (randomized order)

```{r tables_pt1, message=F, warning=F, fig.height=5, fid.width=7}
# round(prop.table(table(df$intensity_fac, df$record_2, df$group_fac), margin=c(2,3)),2)
plt_order <- 
    df %>% 
    group_by(group_fac, time_fac, record_2) %>% 
    summarize(prop_low_intensity = mean(intensity_fac == "low"),
              prop_high_intensity = 1-prop_low_intensity) %>% 
    pivot_longer(cols=c("prop_low_intensity", "prop_high_intensity"), 
                 names_to = "Intensity", values_to = "proportion") %>% 
    mutate(Intensity = factor(Intensity, levels=c("prop_low_intensity","prop_high_intensity"),
                              labels=c("Low intensity","High intensity"))) %>% 
    ggplot() + 
    geom_line(aes(x=record_2, y=proportion, color=group_fac)) + facet_grid(Intensity~time_fac) + 
    ggtitle("Proportion of High vs Low Exposure by Temporal Ordering") + 
    xlab("Temporal Ordering") + scale_x_continuous(breaks=1:10) + 
    geom_hline(yintercept=0.5, col='grey',lty=2)
plt_order
```

Looking at a heatmap of ordering at the indiviudal level, we seethat the ordering does appear to be random, with the apparent constraint that no more than 2 consecutive exposures can be of the same intensity

```{r tables_pt2, message=F, warning=F, fig.height=5, fid.width=15}
plt_order_individual <- 
    df %>% 
    group_by(group_fac) %>% 
    mutate(subject_fac = as.numeric(factor(Subject))) %>% 
    ggplot() + 
    geom_raster(aes(x=record_2, y=subject_fac, fill=intensity_fac)) + 
    facet_grid(group_fac~time_fac) + ylab("Participant") + xlab("Temporal Ordering") + 
    ggtitle("Individual ordering of high vs low intensity exposures") + scale_x_continuous(breaks=1:10) 
plt_order_individual
```

Next, look at how many records each participant has (this can be seen in the heatmap above, but participant identifiers are re-ordered for plotting purposes). We see that there are a few participants with missing data (IDs 69, 108, 604, 605, 699, 1103, 1141), but most participants have complete data. Moreover, there does not appear to be systematic differences in missing data for low vs high exposures. Only one particpant (ID 1103) stands out, with only 4 data points in the post-intervention assessment. 

```{r tables_pt3}
table(df$intensity_fac, df$Subject, df$time_fac)
```

## Plotting the outcome (pain score) data

### Population Distributions

First, using boxplots, plot the distribution of pain intensity reported at pre and post periods (x-axis), stratified by low (left panel) vs high exposure (right panel) for each trial arm (color). We see that at baseline (pre) participants in the placebo and usual care arms tended to report lower pain than the PRT arm. Additionally, the difference appears to vary slightly by high vs low exposures. As a result, for our regression models, we will adjust for baseline group differences.


```{r eda_pt1, message=FALSE, warning=FALSE}
df %>% 
    ggplot() + 
    geom_boxplot(aes(x=time_fac, y=Rating, fill=group_fac), notch=T) + 
    facet_grid(~intensity_fac)
```


If we look at the distribution of outcomes by temporal ordering of exposure, there doesn't appear to be a strong trend, though there is some evidence that average reported pain increases for later high intensity exposures (note the median of the blue boxplots tends to increase slightly across pre and post periods for each trial arm). 


```{r eda_dist_temp_pop}
plt_dist_pop <-
    df %>%
    mutate(record_2_fac = cut(record_2, c(0, 2, 4, 6, 8, 10))) %>%
    ggplot() + 
    geom_boxplot(aes(x=factor(record_2_fac), y=Rating, fill=intensity_fac)) + 
    facet_grid(group_fac~time_fac) + 
    xlab("Temporal Ordering") + ylab("Reported Pain") + 
    ggtitle("Distribution of reported pain by temporal ordering")
plt_dist_pop
```



Given the bounded nature of the data, we are also concerned with potential the potential for a strong mean-variance relationship which would violate the heterskedasticity assumption of linear regression. To assess this, several figures were considered. First, the mean and standard deviation of report pain was stratified by the $q^{th}$ percentiles of the data ($q \in 10, 20, 40, 60, 80, 90, 100$) and temporal ordering (intensity was also considered but no meaningful trends emerged and so the results are not included here). 

The plot below shows that, consistent with the previous figure, there does not appear to be a strong temporal trend in either average or standard deviation of the outcome. However, the variability of reported pain tends to be highest for very low or very high values of reported pain. 

This effect can be partially explained by skewness within the quantiles of reported pain (see frequency plot below), though the potential effect is worth considering in regression analyses.


```{r eda_dist_temp, message=FALSE, warning=FALSE,fig.align="center", fig.width=20, fig.height=5}
plt_dist_summ <- 
    df %>%
    mutate(record_2_fac = cut(record_2, c(0, 2, 4, 6, 8, 10)),
           record_2_fac_num = as.numeric(record_2_fac)) %>%
    mutate(rating_quintile = cut(Rating, c(-1, quantile(Rating, c(0.1,0.2, 0.4, 0.6, 0.8,0.9)), 100))) %>%
    # group_by(rating_quintile, group_fac, time_fac, intensity_fac, record_2_fac_num) %>%
    group_by(rating_quintile, group_fac, time_fac, record_2_fac_num) %>%
    summarize(mn_Y = mean(Rating),
              sd_Y = sd(Rating)) %>%
    ungroup() %>%
    pivot_longer(cols=c("mn_Y","sd_Y"), names_to="measure") %>%
    ggplot(aes(x=record_2_fac_num, y=value, color=group_fac)) +
    geom_point() + geom_line() + scale_x_continuous(breaks=c(1:5),labels=c("(0,2]","(2,4]","(4,6]","(6,8]","(8,10]")) + 
    facet_grid(measure~time_fac + rating_quintile, scales="free_y") + 
    ggtitle("Distribution of mean and standard deviation stratified by rating quantile") + 
    xlab("Temporal Ordering")
plt_dist_summ

```

```{r eda_dist_temp_hist}
df %>%
    ggplot() + 
    geom_freqpoly(aes(x=Rating, color=intensity_fac, alpha=0.5)) + 
    facet_grid(group_fac~time_fac) + ggtitle("Frequencies of Reported Pain by Study Arm") + 
    xlab("Ratin")
    
```

### Individual level EDA

#### Trajectories




```{r heatmap_individuals}
df %>% 
    group_by(Subject, time_fac) %>% 
    mutate(mn_rating_pre = mean(Rating[time_fac == "pre"])) %>% 
    ungroup() %>% 
    group_by(group_fac) %>% 
    arrange(mn_rating_pre, time_fac, record_2) %>% 
    mutate(subj_group_plot = 4)
```

#### Participant level variation

Calculating participant specific averages and standard deviation of reported pain, we see further evidence that variability (generally) exhibits an inverted U shaped association with participant averages. However, there does appear to be some bimodality in the mean-variance relationship in the PRT group in the post-intervention period for *high* exposures. 

An additional point to note is that we see substantial variability in participants' reported pain. Our model should therefore consider modelling these sources of heterogeneous variability in some fashion. 



```{r eda_individuals_pt2, message=F, warning=F}
df %>% 
    group_by(Subject, intensity_fac, time_fac) %>% 
    summarize(mn_Y = mean(Rating),
              sd_Y = sd(Rating),
              group_fac=group_fac[1]) %>%
    ungroup() %>%
    mutate(time_intensity_fac = paste0(time_fac, ", ", intensity_fac)) %>% 
    ggplot() + 
    geom_point(aes(x=mn_Y, y=sd_Y, color=time_intensity_fac)) + 
    facet_grid(~group_fac, scales="free_y") + 
    geom_smooth(aes(x=mn_Y, y=sd_Y, color=time_intensity_fac), method="gam", formula=y~s(x,bs="cr",k=10)) + 
    ylab("Participant-specific standard deviation of reported pain") + 
    xlab("Participant-specific average reported pain")
```


Next we examine the correlation of participants' average and variability of reported pain between the pre and post periods. The figure below shows that pre and post average reported pain are positively correlated, though some notable exceptions are clearly present. For example there are 3 participants (one in each trial arm) who report effectively 0 pain at baseline for high and low exposures, but relatively high levels of pain at the post-intervention assessment. Additionally, one participant in the placebo group reported high pain at baseline, but effectively 0 post-intervention. The data for these participants are plotted for reference.

Lastly, note that the correlation between average pre and post ratings appears relatively consistent across the groups and is approximately linear (barring the influence of potential outlying points).

```{r eda_individuals_pt3, message=F, warning=F}
df %>% 
    group_by(Subject, intensity_fac, time_fac) %>% 
    summarize(mn_Y = mean(Rating),
              sd_Y = sd(Rating),
              group_fac=group_fac[1]) %>%
    ungroup() %>%
    pivot_longer(cols=c("mn_Y","sd_Y"), names_to="measure") %>%
    pivot_wider(names_from="time_fac", values_from = "value") %>%
    # mutate(time_intensity_fac = paste0(time_fac, ", ", intensity_fac)) %>% 
    ggplot() + 
    geom_point(aes(x=pre, y=post, color=intensity_fac)) + 
    facet_wrap(measure~group_fac, scales="free_x",ncol=3) + 
    geom_smooth(aes(x=pre, y=post, color=intensity_fac), method="gam", formula=y~s(x,bs="cr",k=10)) + 
    ylab("Post-Intervention") + 
    xlab("Pre-Intervention") + ggtitle("Pre vs Post Changes in Mean and Variability")
```

```{r eda_individuals_pt4, message=F, warning=F}
df %>% 
    filter(Subject %in% c(904, 1029, 1103, 1231)) %>% 
    mutate(Subject_group = paste0("ID ", Subject, ", ", group_fac)) %>% 
    ggplot() + 
    geom_point(aes(x=record_2, y=Rating, color=intensity_fac)) + 
    facet_grid(Subject_group~time_fac) + 
    geom_line(aes(x=record_2, y=Rating, color=intensity_fac)) +
    ylab("Temporal Ordering") + 
    xlab("Rating") + ggtitle("Trajectories for outlying participants")
```













# Statistical Analyses

## The joint model


```{r fit_model_joint, eval=F}
fit_gaulss4 <- gam(list(Rating ~ group_fac*time_fac*intensity_fac + s(record_2) + s(Subject_fac, bs="re") + 
                            s(Subject_time_fac, bs="re") + s(Subject_time_fac, by=record_2, bs="re"),
                        ~ time_fac + group_fac + s(Rating) + s(record_2) + 
                            s(Subject_fac, bs="re")+ s(Subject_time_fac, bs="re") + 
                            1), data=df, family=gaulss())
summary(fit_gaulss4)
```

## The conditional model


\begin{align*}
a
\end{align*}

```{r fit_model_conditional,eval=F}
df_gam <- 
    df %>% 
    filter(time_fac == "post") %>% 
    
df_gam_pre <-  
    df %>% 
    filter(time_fac == "pre")
uid <- unique(df$Subject)
nid <- length(uid)
nj <- nrow(df_gam)
Xmat <- matrix(50, nj, 10)
Imat_high <- matrix(0, nj, 10)
Lmat <- matrix(0, nj, 10)
for(i in 1:nid){
    id_i <- uid[i]
    inx_post_i <- which(df_gam$Subject == id_i)
    inx_pre_i <- which(df_gam_pre$Subject == id_i)
    
    Lmat[inx_post_i,1:length(inx_pre_i)] <- 1/length(inx_pre_i)
    
    Xmat_i <- matrix(df_gam_pre$Rating[inx_pre_i], length(inx_post_i), length(inx_pre_i), byrow=T)
    Xmat[inx_post_i,1:length(inx_pre_i)] <- Xmat_i
    
    Imat_i <- matrix(as.numeric(df_gam_pre$intensity_fac[inx_pre_i] == "high"),length(inx_post_i), length(inx_pre_i), byrow=T)
    Imat_high[inx_post_i,1:length(inx_pre_i)] <- Imat_i
}

df_gam[["Xmat"]] <- Xmat
df_gam[["Lmat"]] <- Lmat
df_gam[["Imat_high"]] <- Imat_high
df_gam[["LImat_high"]] <- Imat_high*Lmat
df_gam[["UC_mat"]] <- matrix(as.numeric(df_gam$group_fac == "usual care"), nj, 10)
df_gam[["placebo_mat"]] <- matrix(as.numeric(df_gam$group_fac == "placebo"), nj, 10)

fit_gam <- gam(Rating ~ s(Xmat, by=Lmat, bs="cr", k=10), data=df_gam, method="REML")
fit_gam <- gam(Rating ~ s(Xmat, by=Lmat, bs="cr", k=10) + 
                   s(Xmat, by=LImat_high, bs="cr", k=10) + 
                   group_fac*intensity_fac + 
                   s(Subject_fac, bs="re") + 
                   record_2 +
                   s(Subject_fac, by=record_2, bs="re"), data=df_gam, method="REML")
summary(fit_gam)



fit_gam_gaulss_full <- 
    gam(list(Rating ~ 
                 s(Xmat, by=Lmat, bs="cr", k=10) + 
                 s(Xmat, by=LImat_high, bs="cr", k=10) +
                 group_fac*intensity_fac + 
                 s(Subject_fac, bs="re") + 
                 s(Subject_time_fac, bs="re") + 
                 s(record_2) +
                 s(Subject_time_fac, by=record_2, bs="re"),
             ~ s(Xmat, by=Lmat, bs="cr", k=10) + 
                 s(Xmat, by=LImat_high, bs="cr", k=10) +
                 group_fac*intensity_fac + 
                 s(Subject_fac, bs="re") +
                 s(Subject_time_fac, bs="re") +
                 record_2 +
                 s(Rating, bs="cr",k=10) + 
                 s(Subject_time_fac, by=record_2, bs="re") +
                 1), 
        data=df_gam, method="REML",
        family=gaulss)

fit_gam_gaulss <- 
    gam(list(Rating ~ 
                 s(Xmat, by=Lmat, bs="cr", k=10) + 
                 s(Xmat, by=LImat_high, bs="cr", k=10) +
                 group_fac*intensity_fac + 
                 s(Subject_fac, bs="re") + 
                 s(record_2) +
                 s(Subject_fac, by=record_2, bs="re"),
             ~ s(Xmat, by=Lmat, bs="cr", k=10) + 
                 s(Xmat, by=LImat_high, bs="cr", k=10) +
                 group_fac*intensity_fac + 
                 s(Subject_fac, bs="re") +
                 record_2 +
                 s(Rating, bs="cr",k=10) + 
                 s(Subject_fac, by=record_2, bs="re") +
                 1), 
        data=df_gam, method="REML",
        family=gaulss)

# df_gam$resids <- resid(fit_gam_gaulss)
# 
# resid_mat <- 
#     df_gam %>% 
#     dplyr::select(record_2, Subject_fac, resids) %>% 
#     pivot_wider(names_from="record_2", values_from=resids)
# cor_mat <- 
#     resid_mat %>% 
#     dplyr::select(-Subject_fac) %>% 
#     as.matrix() %>% 
#     cor(., use="pairwise.complete.obs")
# fields::image.plot(cor_mat)





fit_gam_gaulss_sub <- 
    gam(list(Rating ~ 
                 s(Xmat, by=Lmat, bs="cr", k=10) + 
                 s(Xmat, by=LImat_high, bs="cr", k=10) +
                 group_fac + intensity_fac + 
                 s(Subject_fac, bs="re") + 
                 s(record_2) +
                 s(Subject_fac, by=record_2, bs="re"),
             ~ s(Xmat, by=Lmat, bs="cr", k=10) + 
                 s(Xmat, by=LImat_high, bs="cr", k=10) +
                 group_fac+intensity_fac + 
                 s(Subject_fac, bs="re") +
                 s(record_2) +
                 s(Rating, bs="cr",k=10) + 
                 s(Subject_fac, by=record_2, bs="re") +
                 1), 
        data=df_gam, method="REML",
        family=gaulss)
summary(fit_gam_gaulss_sub)



fit_gam_gaulss_sub2 <- 
    gam(list(Rating ~ 
                 s(Xmat, by=Lmat, bs="cr", k=10) + 
                 s(Xmat, by=LImat_high, bs="cr", k=10) +
                 group_fac + intensity_fac + 
                 s(Subject_fac, bs="re") + 
                 s(record_2) +
                 s(Subject_fac, by=record_2, bs="re"),
             ~ s(Xmat, by=Lmat, bs="cr", k=10) + 
                 s(Xmat, by=LImat_high, bs="cr", k=10) +
                 group_fac+intensity_fac + 
                 s(Subject_fac, bs="re") +
                 s(record_2) +
                 1), 
        data=df_gam, method="REML",
        family=gaulss)
summary(fit_gam_gaulss_sub2)
```


```{r plot_REs,eval=F}
re_gam_joint <- coef(fit_gam_gaulss)
re_slope_t2 <- re_gam_joint[430:549]

uidt <- unique(df$Subject_time_fac)
nidt <- length(uidt)
slopes <- rep(NA, nidt)
for(i in 1:nidt){
    df_i <- 
        df %>% 
        filter(Subject_time_fac == uidt[i])
    if(nrow(df_i) < 4){
        next
    }
    slopes[i] <- coef(lm(Rating ~ ))
}
```

##


